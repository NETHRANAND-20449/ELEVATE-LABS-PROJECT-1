import os
from datetime import datetime
from typing import List, Dict
import html

class ReportGenerator:
    def __init__(self):
        self.report_data = {}

    def escape_html(self, text):
        if not isinstance(text, str):
            text = str(text)
        return html.escape(text)

    def generate_html_report(self, vulnerabilities: List[Dict], target_url: str) -> str:
        severity_counts = {'Critical': 0, 'High': 0, 'Medium': 0, 'Low': 0}
        vuln_types = {}

        for vuln in vulnerabilities:
            severity = vuln.get('severity', 'Low')
            severity_counts[severity] += 1
            vuln_type = vuln.get('type', 'Unknown')
            vuln_types[vuln_type] = vuln_types.get(vuln_type, 0) + 1

        html_report = f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Vulnerability Scan Report</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 20px; }}
                .header {{ background-color: #f4f4f4; padding: 20px; border-radius: 5px; }}
                .summary {{ margin: 20px 0; padding: 15px; background-color: #e9ecef; }}
                .vulnerability {{ margin: 10px 0; padding: 15px; border-left: 4px solid #ccc; }}
                .critical {{ border-left-color: #dc3545; }}
                .high {{ border-left-color: #fd7e14; }}
                .medium {{ border-left-color: #ffc107; }}
                .low {{ border-left-color: #28a745; }}
                .evidence {{ background-color: #f8f9fa; padding: 10px; margin: 5px 0; font-family: monospace; }}
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Web Application Vulnerability Scan Report</h1>
                <p><strong>Target URL:</strong> {self.escape_html(target_url)}</p>
                <p><strong>Scan Date:</strong> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
                <p><strong>Total Vulnerabilities Found:</strong> {len(vulnerabilities)}</p>
            </div>

            <div class="summary">
                <h2>Summary</h2>
                <p><strong>Critical:</strong> {severity_counts['Critical']}</p>
                <p><strong>High:</strong> {severity_counts['High']}</p>
                <p><strong>Medium:</strong> {severity_counts['Medium']}</p>
                <p><strong>Low:</strong> {severity_counts['Low']}</p>

                <h3>Vulnerability Types Found</h3>
                {''.join([f'<p><strong>{self.escape_html(vtype)}:</strong> {count}</p>' for vtype, count in vuln_types.items()])}
            </div>

            <div class="vulnerabilities">
                <h2>Detailed Findings</h2>
        """

        for i, vuln in enumerate(vulnerabilities, 1):
            severity_class = self.escape_html(vuln.get('severity', 'low').lower())
            html_report += f"""
                <div class="vulnerability {severity_class}">
                    <h3>#{i} - {self.escape_html(vuln.get('type', ''))} ({self.escape_html(vuln.get('severity', ''))})</h3>
                    <p><strong>URL:</strong> {self.escape_html(vuln.get('url', ''))}</p>
                    <p><strong>Method:</strong> {self.escape_html(vuln.get('method', '')).upper()}</p>
                    <p><strong>Parameter:</strong> {self.escape_html(vuln.get('parameter', ''))}</p>
                    <p><strong>Description:</strong> {self.escape_html(vuln.get('description', ''))}</p>
                    <div class="evidence">
                        <strong>Evidence:</strong><br>
                        {self.escape_html(vuln.get('evidence', ''))}<br>
                        <strong>Payload:</strong> {self.escape_html(vuln.get('payload', ''))}
                    </div>
                </div>
            """

        html_report += """
            </div>
        </body>
        </html>
        """

        return html_report

    def save_report(self, html_content: str, filename: str = None) -> str:
        """Save HTML report to the root 'reports/' directory (outside web_interface)"""
        try:
            # Save in /vulnerability_scanner/reports
            project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
            reports_dir = os.path.join(project_root, 'reports')
            os.makedirs(reports_dir, exist_ok=True)

            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            full_path = os.path.join(reports_dir, f"vulnerability_report_{timestamp}.html")

            with open(full_path, 'w', encoding='utf-8') as f:
                f.write(html_content)

            print(f"✅ Report saved to: {full_path}")
            return full_path

        except Exception as e:
            print(f"❌ Error saving report: {str(e)}")
            return None
